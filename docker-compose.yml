version: "3.8"

services:
    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile
        ports:
            - "8000:8000"
        env_file:
            - .env
        environment:
            - MONGODB_URI=${MONGODB_URI}
            - MONGODB_DB=${MONGODB_DB}
            - VULTR_ENDPOINT=${VULTR_ENDPOINT}
            - VULTR_ACCESS_KEY=${VULTR_ACCESS_KEY}
            - VULTR_SECRET_KEY=${VULTR_SECRET_KEY}
            - VULTR_BUCKET=${VULTR_BUCKET}
            - GEMINI_API_KEY=${GEMINI_API_KEY}
            - HEADLESS_URL=http://headless:8001
            - VIDEO_URL=http://video:8002
        depends_on:
            headless:
                condition: service_healthy
            video:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
            interval: 30s
            timeout: 10s
            retries: 3

    headless:
        build:
            context: ./services/headless
            dockerfile: Dockerfile
        ports:
            - "8001:8001"
        env_file:
            - .env
        environment:
            - MONGODB_URI=${MONGODB_URI}
            - MONGODB_DB=${MONGODB_DB}
            - GEMINI_API_KEY=${GEMINI_API_KEY}
            - JOBS_PER_COMPANY=${JOBS_PER_COMPANY:-10}
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
            interval: 30s
            timeout: 10s
            start_period: 30s
            retries: 3

    video:
        build:
            context: ./services/video
            dockerfile: Dockerfile
        ports:
            - "8002:8002"
        env_file:
            - .env
        environment:
            - MONGODB_URI=${MONGODB_URI}
            - MONGODB_DB=${MONGODB_DB}
            - VULTR_ENDPOINT=${VULTR_ENDPOINT}
            - VULTR_ACCESS_KEY=${VULTR_ACCESS_KEY}
            - VULTR_SECRET_KEY=${VULTR_SECRET_KEY}
            - VULTR_BUCKET=${VULTR_BUCKET}
            - GEMINI_API_KEY=${GEMINI_API_KEY}
            - INTERNAL_API_KEY=${INTERNAL_API_KEY}
        volumes:
            - ./services/video/templates:/app/templates:ro
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
            interval: 30s
            timeout: 10s
            retries: 3
