version: "3.8"

services:
    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile
        ports:
            - "8000:8000"
        env_file:
            - .env
        environment:
            - MONGODB_URI=${MONGODB_URI}
            - MONGODB_DB=${MONGODB_DB}
            - VULTR_ENDPOINT=${VULTR_ENDPOINT}
            - VULTR_ACCESS_KEY=${VULTR_ACCESS_KEY}
            - VULTR_SECRET_KEY=${VULTR_SECRET_KEY}
            - VULTR_BUCKET=${VULTR_BUCKET}
            - GEMINI_API_KEY=${GEMINI_API_KEY}
            - HEADLESS_URL=http://headless:8001
            - VIDEO_URL=http://video:8002
        depends_on:
            headless:
                condition: service_healthy
            video:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
            interval: 30s
            timeout: 10s
            retries: 3

    headless:
        build:
            context: ./services/headless
            dockerfile: Dockerfile
        ports:
            - "8001:8001"
        env_file:
            - .env
        environment:
            - MONGODB_URI=${MONGODB_URI}
            - MONGODB_DB=${MONGODB_DB}
            - GEMINI_API_KEY=${GEMINI_API_KEY}
            - JOBS_PER_COMPANY=${JOBS_PER_COMPANY:-10}
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
            interval: 30s
            timeout: 10s
            start_period: 30s
            retries: 3

    video:
        build:
            context: ./services/video
            dockerfile: Dockerfile
        ports:
            - "8002:8002"
        env_file:
            - .env
        environment:
            - MONGODB_URI=${MONGODB_URI}
            - MONGODB_DB=${MONGODB_DB}
            - VULTR_ENDPOINT=${VULTR_ENDPOINT}
            - VULTR_ACCESS_KEY=${VULTR_ACCESS_KEY}
            - VULTR_SECRET_KEY=${VULTR_SECRET_KEY}
            - VULTR_BUCKET=${VULTR_BUCKET}
            - GEMINI_API_KEY=${GEMINI_API_KEY}
            - INTERNAL_API_KEY=${INTERNAL_API_KEY}
        volumes:
            - ./services/video/templates:/app/templates:ro
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
            interval: 30s
            timeout: 10s
            retries: 3

    text-to-video:
        build:
            context: ./text_to_video
            dockerfile: Dockerfile
        ports:
            - "8003:8000"
        env_file:
            - .env
        environment:
            - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
            - FISH_AUDIO_API_KEY=${FISH_AUDIO_API_KEY}
        volumes:
            - text-to-video-cache:/app/cache
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
            interval: 30s
            timeout: 10s
            start_period: 30s
            retries: 3

    generator:
        build:
            context: ./services/generator
            dockerfile: Dockerfile
        env_file:
            - .env
        environment:
            - MONGODB_URI=${MONGODB_URI}
            - MONGODB_DB=${MONGODB_DB}
            - TEXT_TO_VIDEO_API_URL=http://text-to-video:8000
            - DO_SPACES_ENDPOINT=${DO_SPACES_ENDPOINT:-https://tor1.digitaloceanspaces.com}
            - DO_SPACES_ACCESS_KEY=${DO_SPACES_ACCESS_KEY}
            - DO_SPACES_SECRET_KEY=${DO_SPACES_SECRET_KEY}
            - DO_SPACES_BUCKET=${DO_SPACES_BUCKET:-deltahacks-videos}
            - DO_SPACES_REGION=${DO_SPACES_REGION:-tor1}
            - DO_SPACES_CDN_URL=${DO_SPACES_CDN_URL:-https://deltahacks-videos.tor1.cdn.digitaloceanspaces.com}
            - WORKER_ID=generator-local
            - POLL_INTERVAL_S=5
        depends_on:
            text-to-video:
                condition: service_healthy

volumes:
    text-to-video-cache:
